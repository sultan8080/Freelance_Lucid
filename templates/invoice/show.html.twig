{% extends 'dashboard/base.html.twig' %}

{% block title %}Invoice #{{ invoice.invoiceNumber }}
{% endblock %}

{% block dashboard_content %}
	<div class="max-w-5xl mx-auto">

		<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
			<a href="{{ path('app_invoice_index') }}" class="text-slate-500 hover:text-slate-700 transition-colors inline-flex items-center group">
				<div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm mr-2 group-hover:scale-110 transition-transform">
					<i class="fas fa-arrow-left text-xs"></i>
				</div>
				Back to Invoices
			</a>

			<div class="flex gap-3 w-full md:w-auto">
				{% if invoice.status == 'DRAFT' %}
					<a href="{{ path('app_invoice_edit', {id: invoice.id}) }}" class="flex-1 md:flex-none justify-center inline-flex items-center bg-primary text-white px-5 py-2.5 rounded-xl text-sm font-semibold hover:bg-primary-hover shadow-indigo-glow transition-all hover:-translate-y-0.5">
						<i class="fas fa-pen mr-2"></i>
						Edit Invoice
					</a>
				{% else %}
					<a href="{{ path('app_invoice_export_pdf', {id: invoice.id}) }}" target="_blank" class="flex-1 md:flex-none justify-center inline-flex items-center bg-white text-slate-700 border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-semibold hover:bg-slate-50 transition-all">
						<i class="fas fa-file-pdf mr-2"></i>
						Download PDF
					</a>
				{% endif %}
			</div>
		</div>

		<div class="glass-card p-8 md:p-12 rounded-2xl print:shadow-none print:border-none print:p-0">

			<div class="flex flex-col md:flex-row justify-between items-start border-b border-slate-100 pb-8 mb-8 gap-8">

				<div class="flex flex-col gap-3">
					<div class="flex items-center gap-4">
						<h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 tracking-tight">INVOICE</h1>

						{# Status Badge Logic #}
						{% set badgeClass = 'bg-slate-100 text-slate-500' %}
						{% if invoice.status == 'SENT' %}
							{% set badgeClass = 'bg-blue-100 text-blue-700 ring-1 ring-blue-200' %}
						{% elseif invoice.status == 'PAID' %}
							{% set badgeClass = 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200' %}
						{% elseif invoice.status == 'UNPAID' %}
							{% set badgeClass = 'bg-amber-100 text-amber-700 ring-1 ring-amber-200' %}
						{% endif %}

						<span class="px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider {{ badgeClass }}">
							{{ invoice.status }}
						</span>
					</div>

					{% if invoice.projectTitle %}
						<div class="inline-flex items-center text-slate-500 text-sm font-medium bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100 w-fit">
							<i class="fas fa-folder-open mr-2 text-slate-400"></i>
							{{ invoice.projectTitle }}
						</div>
					{% endif %}
				</div>

				<div class="w-full md:w-auto bg-slate-50 rounded-xl p-5 border border-slate-100">
					<div class="flex flex-col md:flex-row gap-6 md:gap-8">

						<div class="md:text-right border-b md:border-b-0 md:border-r border-slate-200/60 pb-3 md:pb-0 md:pr-8 last:border-0 last:pr-0">
							<div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Invoice No</div>
							<div class="text-slate-800 font-bold text-lg leading-none">#{{ invoice.invoiceNumber|default('DRAFT') }}</div>
						</div>

						<div class="md:text-right border-b md:border-b-0 md:border-r border-slate-200/60 pb-3 md:pb-0 md:pr-8 last:border-0 last:pr-0">
							<div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Issue Date</div>
							<div class="text-slate-700 font-medium leading-none">{{ invoice.sentAt ? invoice.sentAt|date('d M Y') : 'Draft' }}</div>
						</div>

						<div class="md:text-right">
							<div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Due Date</div>
							<div class="text-slate-900 font-bold leading-none {{ invoice.isOverdue ? 'text-red-500' : '' }}">
								{{ invoice.dueDate ? invoice.dueDate|date('d M Y') : '-' }}
							</div>
						</div>

					</div>
				</div>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-2 gap-12 mb-12">

				<div class="space-y-4">
					<h3 class="flex items-center text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 border-b border-slate-100 pb-2">
						<i class="fas fa-building mr-2 text-slate-300"></i>
						From
					</h3>
					<div>
						{# 1. Company / Full Name #}
						<div class="text-slate-900 font-bold text-xl">
							{{ app.user.companyName|default(app.user.firstName ~ ' ' ~ app.user.lastName) }}
						</div>

						{# 2. Contact Person (if company name is used above) #}
						{% if app.user.companyName is defined and app.user.companyName %}
							<div class="text-slate-600 font-medium text-sm mt-1">{{ app.user.firstName }}
								{{ app.user.lastName }}</div>
						{% endif %}

						{# 3. Address #}
						<div class="text-slate-500 text-sm mt-2 whitespace-pre-line leading-relaxed">
							{{ app.user.address|default('No address defined in profile') }}
							{{ app.user.postCode|default('') }}
							{{ app.user.city|default('') }}
							{{ app.user.country|default('') }}
						</div>

						<div class="text-slate-500 text-sm mt-1">{{ app.user.email }}</div>

						{# 4. Legal / SIRET (Mandatory) #}
						<div class="mt-4 pt-3 border-t border-dashed border-slate-200">
							<div class="text-xs text-slate-400 uppercase tracking-wider font-semibold">Legal Information</div>
							<div class="text-slate-600 text-xs mt-1 font-mono">
								SIRET:
								{{ app.user.siret|default('---') }}<br>
								VAT:
								{{ app.user.vatNumber|default('Not Applicable') }}
							</div>
						</div>
					</div>
				</div>

				<div class="space-y-4 md:text-right">
					<h3 class="flex items-center md:justify-end text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 border-b border-slate-100 pb-2">
						<i class="fas fa-user mr-2 text-slate-300"></i>
						Bill To
					</h3>

					{# Data Logic: Snapshot vs Live #}
					{% set clientName = invoice.frozenClientName ?: (invoice.client ? invoice.client.fullName : 'No Client Selected') %}
					{% set clientCompany = invoice.frozenClientCompanyName ?: (invoice.client ? invoice.client.companyName : '') %}
					{% set clientAddress = invoice.frozenClientAddress ?: (invoice.client ? invoice.client.address ~ ', ' ~ invoice.client.city : '') %}
					{% set clientSiret = invoice.frozenClientSiret ?: (invoice.client ? invoice.client.siret : '') %}
					{% set clientVat = invoice.frozenClientVat ?: (invoice.client ? invoice.client.vatNumber : '') %}

					<div>
						<div class="text-slate-900 font-bold text-xl">{{ clientName }}</div>

						{% if clientCompany %}
							<div class="text-slate-700 font-medium text-sm">{{ clientCompany }}</div>
						{% endif %}

						{% if clientAddress %}
							<div class="text-slate-500 text-sm mt-2 leading-relaxed whitespace-pre-line">{{ clientAddress }}</div>
						{% else %}
							<div class="text-red-300 text-xs italic mt-1">No address provided</div>
						{% endif %}

						{# Client Legal Info (Optional but good practice) #}
						{% if clientSiret or clientVat %}
							<div class="mt-4 pt-3 border-t border-dashed border-slate-200 md:ml-auto w-fit">
								<div class="text-xs text-slate-400 uppercase tracking-wider font-semibold">Client Details</div>
								<div class="text-slate-600 text-xs mt-1 font-mono">
									{% if clientSiret %}SIRET:
										{{ clientSiret }}<br>
									{% endif %}
									{% if clientVat %}VAT:
										{{ clientVat }}
									{% endif %}
								</div>
							</div>
						{% endif %}
					</div>
				</div>
			</div>

			<div class="overflow-hidden rounded-xl border border-slate-200 mb-8">
				<table class="w-full text-left">
					<thead class="bg-slate-50/80 border-b border-slate-200">
						<tr>
							<th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Description</th>
							<th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Qty</th>
							<th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Price</th>
							<th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Total</th>
						</tr>
					</thead>
					<tbody class="divide-y divide-slate-100 text-sm text-slate-700 bg-white">
						{% for item in invoice.invoiceItems %}
							<tr>
								<td class="px-6 py-4 font-medium">{{ item.description }}</td>
								<td class="px-6 py-4 text-right text-slate-500 font-mono">{{ item.quantity }}</td>
								<td class="px-6 py-4 text-right text-slate-500 font-mono">{{ item.unitPrice|number_format(2) }}</td>
								<td class="px-6 py-4 text-right font-bold text-slate-800 font-mono">{{ item.totalHt|number_format(2) }}</td>
							</tr>
						{% else %}
							<tr>
								<td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">No items added to this invoice.</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>

			<div class="flex justify-end">
				<div class="w-full md:w-5/12 lg:w-4/12 space-y-3">

					<div class="flex justify-between text-slate-500 text-sm px-2">
						<span class="font-medium">Subtotal (HT)</span>
						<span class="font-mono">{{ invoice.totalHt|number_format(2) }}
							{{ invoice.currency }}</span>
					</div>

					<div class="flex justify-between text-slate-500 text-sm px-2">
						<span class="font-medium">VAT Amount</span>
						<span class="font-mono">{{ invoice.totalVat|number_format(2) }}
							{{ invoice.currency }}</span>
					</div>

					<div class="mt-4 pt-4 border-t-2 border-slate-100 flex justify-between items-center px-2">
						<span class="text-slate-800 font-bold text-lg">Total Amount</span>
						<span class="text-3xl font-extrabold text-primary tracking-tight">
							{{ invoice.totalAmount|number_format(2) }}
							<span class="text-lg text-slate-400 font-medium">{{ invoice.currency }}</span>
						</span>
					</div>
					<div class="text-right text-xs text-slate-400 mt-1">All taxes included (TTC)</div>
				</div>
			</div>

			{% if invoice.paidAt %}
				<div class="mt-12 p-4 bg-emerald-50 border border-emerald-100 rounded-xl flex items-center justify-center gap-3 print:hidden">
					<div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
						<i class="fas fa-check"></i>
					</div>
					<div class="text-emerald-800 font-medium">
						This invoice was fully paid on
						<span class="font-bold">{{ invoice.paidAt|date('d F Y') }}</span>
					</div>
				</div>
			{% endif %}

			<div class="mt-12 pt-8 border-t border-slate-100 text-center">
				<p class="text-slate-400 text-xs">
					Dear client. Please include invoice number
					<strong>#{{ invoice.invoiceNumber|default('DRAFT') }}</strong>
					for further reference.
				</p>
			</div>

		</div>

		{# --- NEW: PRIVATE FINANCIAL INSIGHTS --- #}
		<div class="mt-8 mb-12 print:hidden animate-fade-in-up">
			<div class="bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-200 rounded-2xl p-6 flex flex-col md:flex-row items-center justify-between gap-6 shadow-sm">

				<div class="flex items-center gap-4">
					<div class="w-12 h-12 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm">
						<i class="fas fa-eye-slash"></i>
					</div>
					<div>
						<h3 class="text-slate-800 font-bold text-sm uppercase tracking-wide">Private Financial Insight</h3>
						<p class="text-slate-500 text-xs mt-0.5 max-w-xs">

						Dear {{invoice.user.firstName}}, here is an estimated breakdown of your earnings after URSSAF contributions based on this invoice.
							This breakdown is visible only to you. It is <strong>never</strong> included on the client's PDF.
						</p>
					</div>
				</div>

				<div
					class="flex items-center gap-8 w-full md:w-auto border-t md:border-t-0 border-slate-200 pt-4 md:pt-0 justify-around md:justify-end">

					{# 1. The Tax Estimate #}
					<div class="text-right">
						<div class="text-[10px] uppercase tracking-wider font-bold text-slate-400 mb-1">
							Est. URSSAF (21.2%)
						</div>
						<div class="text-red-500/80 font-bold text-lg font-mono">
							{{ invoice.urssafEstimate|number_format(2) }}€
						</div>
					</div>

					{# 2. The Net Pocket Money #}
					<div class="text-right">
						<div class="text-[10px] uppercase tracking-wider font-bold text-slate-400 mb-1">
							Net in Pocket
						</div>
						<div class="text-emerald-600 font-extrabold text-2xl font-mono">
							{{ invoice.netEstimate|number_format(2) }}€
						</div>
					</div>

				</div>
			</div>
		</div>
		{# --- END PRIVATE INSIGHTS --- #}
	</div>
{% endblock %}
